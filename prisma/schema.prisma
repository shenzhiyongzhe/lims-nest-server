generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  username         String            @db.VarChar(10)
  password         String            @default("123456") @db.VarChar(32)
  phone            String?           @db.VarChar(11)
  address          String            @db.VarChar(100)
  lv               String            @default("青铜用户") @db.VarChar(16)
  overtime         Int?              @default(0)
  overdue_time     Int?              @default(0)
  is_high_risk     Boolean?          @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime?         @updatedAt
  loanAccounts     LoanAccount[]
  orders           Order[]
  repaymentRecords RepaymentRecord[]

  @@map("users")
}

model Admin {
  id                            Int                            @id @default(autoincrement())
  username                      String                         @db.VarChar(10)
  password                      String                         @default("123456") @db.VarChar(32)
  email                         String?                        @db.VarChar(100)
  role                          ManagementRoles
  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime?                      @updatedAt
  assetReductionHistory         AssetReductionHistory[]        @relation("AssetReductionHistory")
  collectorAssetManagement      CollectorAssetManagement?
  dailyStatistics               DailyStatistics[]
  loanAccountRoles              LoanAccountRole[]
  loanAccountsAsCollector       LoanAccount[]                  @relation("CollectorLoanAccounts")
  loanAccountsAsLender          LoanAccount[]                  @relation("LenderLoanAccounts")
  loanAccountsAsRiskController  LoanAccount[]                  @relation("RiskControllerLoanAccounts")
  payees                        Payee[]
  repaymentRecords              RepaymentRecord[]
  riskControllerAssetManagement RiskControllerAssetManagement?

  @@map("admins")
}

model LoanAccount {
  id                       String              @id @default(cuid())
  user_id                  Int
  loan_amount              Decimal             @db.Decimal(10, 2)
  receiving_amount         Decimal?            @db.Decimal(10, 2)
  to_hand_ratio            Decimal?            @db.Decimal(10, 2)
  capital                  Decimal             @db.Decimal(10, 2)
  interest                 Decimal             @db.Decimal(10, 2)
  due_start_date           DateTime            @db.Date
  due_end_date             DateTime            @db.Date
  status                   LoanAccountStatus   @default(pending)
  handling_fee             Decimal             @db.Decimal(10, 2)
  total_periods            Int
  repaid_periods           Int                 @default(0)
  daily_repayment          Int                 @default(0)
  company_cost             Int                 @default(0)
  created_at               DateTime            @default(now())
  created_by               Int
  updated_at               DateTime?           @updatedAt
  collector_id             Int
  lender_id                Int
  risk_controller_id       Int
  apply_times              Int                 @default(0)
  paid_capital             Decimal             @default(0.00) @db.Decimal(10, 2)
  status_changed_at        DateTime?
  total_fines              Decimal             @default(0.00) @db.Decimal(10, 2)
  paid_interest            Decimal             @default(0.00) @db.Decimal(10, 2)
  early_settlement_capital Decimal?            @db.Decimal(10, 2)
  last_edit_fines          Decimal?            @db.Decimal(10, 2)
  last_edit_pay_capital    Decimal?            @db.Decimal(10, 2)
  last_edit_pay_interest   Decimal?            @db.Decimal(10, 2)
  note                     String?             @db.VarChar(300)
  overdue_count            Int                 @default(0)
  ownership                String?             @db.VarChar(2)
  loanAccountRoles         LoanAccountRole[]
  collector                Admin               @relation("CollectorLoanAccounts", fields: [collector_id], references: [id])
  lender                   Admin               @relation("LenderLoanAccounts", fields: [lender_id], references: [id])
  risk_controller          Admin               @relation("RiskControllerLoanAccounts", fields: [risk_controller_id], references: [id])
  user                     User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  repaymentRecords         RepaymentRecord[]
  repaymentSchedules       RepaymentSchedule[]
  dailyRandomDecimals      DailyRandomDecimal[]

  @@index([collector_id], map: "loan_accounts_collector_id_fkey")
  @@index([lender_id], map: "loan_accounts_lender_id_fkey")
  @@index([risk_controller_id], map: "loan_accounts_risk_controller_id_fkey")
  @@index([user_id], map: "loan_accounts_user_id_fkey")
  @@map("loan_accounts")
}

model LoanAccountRole {
  id              Int         @id @default(autoincrement())
  loan_account_id String
  admin_id        Int
  role_type       String      @db.VarChar(20)
  created_at      DateTime    @default(now())
  admin           Admin       @relation(fields: [admin_id], references: [id])
  loan_account    LoanAccount @relation(fields: [loan_account_id], references: [id], onDelete: Cascade)

  @@unique([loan_account_id, admin_id, role_type])
  @@index([admin_id], map: "loan_account_roles_admin_id_fkey")
  @@map("loan_account_roles")
}

model RepaymentSchedule {
  id                  Int                     @id @default(autoincrement())
  loan_id             String
  period              Int
  due_start_date      DateTime                @db.Date
  due_amount          Decimal                 @db.Decimal(10, 2)
  capital             Decimal?                @db.Decimal(10, 2)
  interest            Decimal?                @db.Decimal(10, 2)
  status              RepaymentScheduleStatus @default(pending)
  paid_amount         Decimal?                @db.Decimal(10, 2)
  paid_at             DateTime?
  fines               Decimal?                @default(0.00) @db.Decimal(10, 2)
  collected_by_type   CollectionSource?
  operator_admin_id   Int?
  operator_admin_name String?                 @db.VarChar(50)
  paid_capital        Decimal?                @default(0.00) @db.Decimal(10, 2)
  paid_interest       Decimal?                @default(0.00) @db.Decimal(10, 2)
  overdueRecords      OverdueRecord?
  repaymentRecords    RepaymentRecord[]
  loan_account        LoanAccount             @relation(fields: [loan_id], references: [id], onDelete: Cascade)

  @@index([loan_id], map: "repayment_schedules_loan_id_fkey")
  @@map("repayment_schedules")
}

model RepaymentRecord {
  id                    Int                @id @default(autoincrement())
  loan_id               String
  user_id               Int
  paid_amount           Int?
  paid_amount_decimal   Decimal?           @db.Decimal(10, 2)
  paid_at               DateTime           @default(now())
  payment_method        PaymentMethod      @default(wechat_pay)
  remark                String?            @db.VarChar(255)
  order_id              String?
  collected_by_type     CollectionSource   @default(grabbed)
  paid_capital          Decimal?           @db.Decimal(10, 2)
  paid_fines            Decimal?           @db.Decimal(10, 2)
  paid_interest         Decimal?           @db.Decimal(10, 2)
  repayment_schedule_id Int?
  actual_collector_id   Int?
  actual_collector      Admin?             @relation(fields: [actual_collector_id], references: [id])
  loan_account          LoanAccount        @relation(fields: [loan_id], references: [id])
  order                 Order?             @relation(fields: [order_id], references: [id])
  repayment_schedule    RepaymentSchedule? @relation(fields: [repayment_schedule_id], references: [id])
  user                  User               @relation(fields: [user_id], references: [id])

  @@index([actual_collector_id], map: "repayment_records_actual_collector_id_fkey")
  @@index([loan_id], map: "repayment_records_loan_id_fkey")
  @@index([order_id], map: "repayment_records_order_id_fkey")
  @@index([repayment_schedule_id], map: "repayment_records_repayment_schedule_id_fkey")
  @@index([user_id], map: "repayment_records_user_id_fkey")
  @@map("repayment_records")
}

model OverdueRecord {
  id           Int               @id @default(autoincrement())
  user_id      Int
  loan_id      String
  schedule_id  Int               @unique
  collector    String            @db.VarChar(10)
  overdue_date DateTime
  created_at   DateTime          @default(now())
  schedule     RepaymentSchedule @relation(fields: [schedule_id], references: [id], onDelete: Cascade)

  @@index([collector, overdue_date])
  @@index([overdue_date])
  @@index([user_id, overdue_date])
  @@map("overdue_records")
}

model Payee {
  id              Int                    @id @default(autoincrement())
  admin_id        Int
  username        String                 @db.VarChar(10)
  address         String                 @db.VarChar(100)
  payment_limit   Int                    @default(20000)
  qrcode_number   Int                    @default(5)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime?              @updatedAt
  remaining_limit Int                    @default(20000)
  is_disabled     Boolean
  orders          Order[]
  dailyStatistics PayeeDailyStatistics[]
  ranking         PayeeRanking?
  admin           Admin                  @relation(fields: [admin_id], references: [id], onDelete: Cascade)
  qrcode          QrCode[]

  @@index([admin_id], map: "payees_admin_id_fkey")
  @@map("payees")
}

model QrCode {
  id          Int           @id @default(autoincrement())
  payee_id    Int
  qrcode_url  String        @db.VarChar(255)
  qrcode_type PaymentMethod @default(wechat_pay)
  active      Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime?     @updatedAt
  payee       Payee         @relation(fields: [payee_id], references: [id])

  @@index([payee_id], map: "qr_codes_payee_id_fkey")
  @@map("qr_codes")
}

model Order {
  id                       String                 @id @default(cuid())
  customer_id              Int
  loan_id                  String
  amount                   Decimal                @db.Decimal(10, 2)
  payment_periods          Int
  payment_method           PaymentMethod
  remark                   String?                @db.VarChar(255)
  status                   OrderStatus            @default(pending)
  payee_id                 Int?
  created_at               DateTime               @default(now())
  updated_at               DateTime?              @updatedAt
  expires_at               DateTime
  collected_by_type        CollectionSource       @default(grabbed)
  actual_paid_amount       Decimal?               @db.Decimal(10, 2)
  grabbed_at               DateTime?
  manual_processing_status ManualProcessingStatus @default(unprocessed)
  needs_manual_processing  Boolean                @default(false)
  payment_feedback         PaymentFeedback        @default(no_feedback)
  review_status            ReviewStatus           @default(pending_review)
  
  customer                 User                   @relation(fields: [customer_id], references: [id])
  payee                    Payee?                 @relation(fields: [payee_id], references: [id])
  repaymentRecords         RepaymentRecord[]

  @@index([status, created_at])
  @@index([payee_id, created_at])
  @@index([customer_id, created_at])
  @@map("orders")
}

model DailyStatistics {
  id                          Int      @id @default(autoincrement())
  date                        DateTime @db.Date
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt
  admin_id                    Int
  admin_name                  String   @db.VarChar(10)
  role                        String   @db.VarChar(20)
  total_fines                 Decimal  @default(0.00) @db.Decimal(12, 2)
  total_handling_fee          Decimal  @default(0.00) @db.Decimal(12, 2)
  active_count                Int      @default(0)
  last_month_blacklist_count  Int      @default(0)
  last_month_fines            Decimal  @default(0.00) @db.Decimal(12, 2)
  last_month_handling_fee     Decimal  @default(0.00) @db.Decimal(12, 2)
  this_month_blacklist_count  Int      @default(0)
  this_month_fines            Decimal  @default(0.00) @db.Decimal(12, 2)
  this_month_handling_fee     Decimal  @default(0.00) @db.Decimal(12, 2)
  this_month_negotiated_count Int      @default(0)
  this_month_new_amount       Decimal  @default(0.00) @db.Decimal(12, 2)
  this_month_settled_amount   Decimal  @default(0.00) @db.Decimal(12, 2)
  today_blacklist_count       Int      @default(0)
  today_collection            Decimal  @default(0.00) @db.Decimal(12, 2)
  today_fines                 Decimal  @default(0.00) @db.Decimal(12, 2)
  today_handling_fee          Decimal  @default(0.00) @db.Decimal(12, 2)
  today_negotiated_count      Int      @default(0)
  today_new_amount            Decimal  @default(0.00) @db.Decimal(12, 2)
  today_paid_count            Int      @default(0)
  today_pending_count         Int      @default(0)
  today_settled_amount        Decimal  @default(0.00) @db.Decimal(12, 2)
  today_unpaid_amount         Decimal  @default(0.00) @db.Decimal(12, 2)
  total_amount                Decimal  @default(0.00) @db.Decimal(12, 2)
  total_blacklist_count       Int      @default(0)
  total_in_stock_amount       Decimal  @default(0.00) @db.Decimal(12, 2)
  total_in_stock_count        Int      @default(0)
  total_negotiated_count      Int      @default(0)
  total_received_amount       Decimal  @default(0.00) @db.Decimal(12, 2)
  yesterday_collection        Decimal  @default(0.00) @db.Decimal(12, 2)
  yesterday_overdue_count     Int      @default(0)
  admin                       Admin    @relation(fields: [admin_id], references: [id])

  @@unique([admin_id, date, role])
  @@index([date])
  @@index([admin_id])
  @@map("daily_statistics")
}

model PayeeRanking {
  id          Int      @id @default(autoincrement())
  payee_id    Int      @unique
  decimal_sum Decimal  @default(0.00) @db.Decimal(10, 2)
  updated_at  DateTime @updatedAt
  payee       Payee    @relation(fields: [payee_id], references: [id], onDelete: Cascade)

  @@map("payee_rankings")
}

model PayeeDailyStatistics {
  id           Int      @id @default(autoincrement())
  payee_id     Int
  date         DateTime @db.Date
  daily_total  Decimal  @default(0.00) @db.Decimal(12, 2)
  total_amount Decimal  @default(0.00) @db.Decimal(12, 2)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  payee        Payee    @relation(fields: [payee_id], references: [id], onDelete: Cascade)

  @@unique([payee_id, date])
  @@index([payee_id, date])
  @@map("payee_daily_statistics")
}

model OperationLog {
  id             Int           @id @default(autoincrement())
  entity_type    String        @db.VarChar(50)
  entity_id      String        @db.VarChar(255)
  operation_type OperationType
  admin_id       Int
  admin_username String        @db.VarChar(50)
  old_data       String?       @db.Text
  new_data       String?       @db.Text
  ip_address     String?       @db.VarChar(45)
  created_at     DateTime      @default(now())

  @@index([entity_type, created_at])
  @@index([admin_id, created_at])
  @@index([created_at])
  @@index([operation_type])
  @@map("operation_logs")
}

model CollectorAssetManagement {
  id                   Int      @id @default(autoincrement())
  admin_id             Int      @unique
  total_handling_fee   Decimal  @default(0.00) @db.Decimal(10, 2)
  total_fines          Decimal  @default(0.00) @db.Decimal(10, 2)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
  reduced_fines        Decimal  @default(0.00) @db.Decimal(10, 2)
  reduced_handling_fee Decimal  @default(0.00) @db.Decimal(10, 2)
  admin                Admin    @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("collector_asset_management")
}

model RiskControllerAssetManagement {
  id             Int      @id @default(autoincrement())
  admin_id       Int      @unique
  total_amount   Decimal  @default(0.00) @db.Decimal(10, 2)
  reduced_amount Decimal  @default(0.00) @db.Decimal(10, 2)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  admin          Admin    @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("risk_controller_asset_management")
}

model LoanFieldPrediction {
  id           Int      @id @default(autoincrement())
  field_name   String   @db.VarChar(50)
  value        Decimal  @db.Decimal(10, 2)
  frequency    Int      @default(1)
  last_used_at DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([field_name, value])
  @@index([field_name, frequency])
  @@index([field_name, value])
  @@map("loan_field_predictions")
}

model AssetReductionHistory {
  id                        Int      @id @default(autoincrement())
  admin_id                  Int
  asset_type                String   @db.VarChar(50)
  field_name                String   @db.VarChar(50)
  old_value                 Decimal  @db.Decimal(10, 2)
  input_value               Decimal  @db.Decimal(10, 2)
  new_value                 Decimal  @db.Decimal(10, 2)
  updated_by_admin_id       Int?
  updated_by_admin_username String?  @db.VarChar(50)
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  admin                     Admin    @relation("AssetReductionHistory", fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id], map: "asset_reduction_history_admin_id_fkey")
  @@map("asset_reduction_history")
}

enum ManagementRoles {
  ADMIN
  FINANCIAL
  RISK_CONTROLLER
  COLLECTOR
  PAYEE
  PAYER
}

enum LoanAccountStatus {
  pending
  active
  overdue
  settled
  unsettled
  negotiated
  to_be_processed
  blacklist
}

enum RepaymentScheduleStatus {
  pending
  active
  overdue
  paid
  terminated
}

enum PaymentMethod {
  wechat_pay
  ali_pay
}

enum CollectionSource {
  grabbed
  manual
}

enum OrderStatus {
  pending
  grabbed
  completed
  expired
  cancelled
}

enum ManualProcessingStatus {
  processed
  unprocessed
}

enum PaymentFeedback {
  success
  failed
  no_feedback
}

enum ReviewStatus {
  pending_review
  reviewed
}

enum OperationType {
  CREATE
  UPDATE
  DELETE
}

model DailyRandomDecimal {
  id                Int      @id @default(autoincrement())
  loan_id           String
  period            Int
  date              DateTime @db.Date
  decimal           Int      // 1-99
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  loan_account      LoanAccount @relation(fields: [loan_id], references: [id], onDelete: Cascade)

  @@unique([loan_id, period, date])
  @@index([loan_id, period, date])
  @@index([date])
  @@map("daily_random_decimals")
}
