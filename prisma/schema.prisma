generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  username     String    @db.VarChar(10)
  password     String    @default("123456") @db.VarChar(32)
  phone        String?   @db.VarChar(11)
  address      String    @db.VarChar(100)
  lv           String    @default("青铜用户") @db.VarChar(16)
  overtime     Int?      @default(0)
  overdue_time Int?      @default(0)
  is_high_risk Boolean?  @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime? @updatedAt

  loanAccounts     LoanAccount[]
  orders           Order[]
  repaymentRecords RepaymentRecord[]

  @@map("users")
}

// 复用的枚举（还款状态）
enum ManagementRoles {
  管理员
  财务员
  风控人
  负责人
  收款人
  打款人
}

model Admin {
  id        Int             @id @default(autoincrement())
  username  String          @db.VarChar(10)
  password  String          @default("123456") @db.VarChar(32)
  phone     String?         @db.VarChar(11)
  role      ManagementRoles
  createdAt DateTime        @default(now())
  updatedAt DateTime?       @updatedAt

  // 添加关系
  payees                       Payee[]
  loanAccountRoles             LoanAccountRole[]
  loanAccountsAsCollector      LoanAccount[]     @relation("CollectorLoanAccounts")
  loanAccountsAsRiskController LoanAccount[]     @relation("RiskControllerLoanAccounts")
  loanAccountsAsLender         LoanAccount[]     @relation("LenderLoanAccounts")
  dailyStatistics              DailyStatistics[]

  @@map("admins")
}

// 复用的枚举（还款状态）
enum LoanAccountStatus {
  pending
  active
  overdue
  settled
  unsettled
  negotiated
  to_be_processed
  blacklist
}

enum RepaymentScheduleStatus {
  pending
  active
  overdue
  paid
  terminated
}

model LoanAccount {
  id                 String            @id @default(cuid())
  user_id            Int
  loan_amount        Decimal           @db.Decimal(10, 2)
  receiving_amount   Decimal?          @db.Decimal(10, 2)
  paid_capital       Decimal           @default(0) @db.Decimal(10, 2)
  paid_interest      Decimal           @default(0) @db.Decimal(10, 2)
  total_fines        Decimal           @default(0) @db.Decimal(10, 2)
  to_hand_ratio      Decimal?          @db.Decimal(10, 2)
  capital            Decimal           @db.Decimal(10, 2)
  interest           Decimal           @db.Decimal(10, 2)
  due_start_date     DateTime @db.Date
  due_end_date       DateTime @db.Date
  apply_times        Int               @default(0)
  status             LoanAccountStatus @default(pending)
  handling_fee       Decimal           @db.Decimal(10, 2)
  total_periods      Int
  repaid_periods     Int               @default(0)
  daily_repayment    Decimal           @db.Decimal(10, 2)
  risk_controller_id Int
  collector_id       Int
  lender_id          Int
  company_cost       Int               @default(0)
  created_at         DateTime          @default(now())
  created_by         Int
  updated_at         DateTime?         @updatedAt
  status_changed_at  DateTime?
  note               String?           @db.VarChar(300)
  last_edit_pay_capital   Decimal?     @db.Decimal(10, 2)
  last_edit_pay_interest  Decimal?     @db.Decimal(10, 2)
  last_edit_fines         Decimal?     @db.Decimal(10, 2)
  // 提前结清本金与利息（与已还本金/利息区分开）
  early_settlement_capital  Decimal?   @db.Decimal(10, 2)
  early_settlement_interest Decimal?   @db.Decimal(10, 2)

  // 关系
  user               User                @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  risk_controller    Admin               @relation("RiskControllerLoanAccounts", fields: [risk_controller_id], references: [id])
  collector          Admin               @relation("CollectorLoanAccounts", fields: [collector_id], references: [id])
  lender             Admin               @relation("LenderLoanAccounts", fields: [lender_id], references: [id])
  repaymentSchedules RepaymentSchedule[]
  repaymentRecords   RepaymentRecord[]
  loanAccountRoles   LoanAccountRole[]

  @@map("loan_accounts")
}

model LoanAccountRole {
  id              Int      @id @default(autoincrement())
  loan_account_id String
  admin_id        Int
  role_type       String   @db.VarChar(20) // 'collector', 'risk_controller', 'payee', 'lender'
  created_at      DateTime @default(now())

  loan_account LoanAccount @relation(fields: [loan_account_id], references: [id], onDelete: Cascade)
  admin        Admin       @relation(fields: [admin_id], references: [id])

  @@unique([loan_account_id, admin_id, role_type])
  @@map("loan_account_roles")
}

model RepaymentSchedule {
  id                  Int                     @id @default(autoincrement())
  loan_id             String
  period              Int
  due_start_date      DateTime @db.Date
  due_amount          Decimal                 @db.Decimal(10, 2)
  capital             Decimal?                @db.Decimal(10, 2)
  interest            Decimal?                @db.Decimal(10, 2)
  paid_capital        Decimal?                @default(0) @db.Decimal(10, 2)
  paid_interest       Decimal?                @default(0) @db.Decimal(10, 2)
  fines               Decimal?                @default(0) @db.Decimal(10, 2)
  status              RepaymentScheduleStatus @default(pending)
  paid_amount         Decimal?                @db.Decimal(10, 2)
  paid_at             DateTime?
  collected_by_type   CollectionSource?
  operator_admin_id   Int?
  operator_admin_name String?                 @db.VarChar(50)

  // 外键关系到 LoanAccount
  loan_account     LoanAccount       @relation(fields: [loan_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  overdueRecords   OverdueRecord[]
  repaymentRecords RepaymentRecord[]

  @@map("repayment_schedules")
}

enum PaymentMethod {
  wechat_pay
  ali_pay
}

// 收款来源：抢单 or 手动
enum CollectionSource {
  grabbed
  manual
}

model RepaymentRecord {
  id                    Int              @id @default(autoincrement())
  loan_id               String
  user_id               Int
  paid_amount           Decimal?         @db.Decimal(10, 2)
  paid_at               DateTime         @default(now())
  payment_method        PaymentMethod    @default(wechat_pay)
  payee_id              Int
  remark                String?          @db.VarChar(255)
  order_id              String
  collected_by_type     CollectionSource @default(grabbed)
  operator_admin_id     Int?
  operator_admin_name   String?          @db.VarChar(50)
  paid_capital          Decimal?         @db.Decimal(10, 2)
  paid_interest         Decimal?         @db.Decimal(10, 2)
  paid_fines            Decimal?         @db.Decimal(10, 2)
  repayment_schedule_id Int?

  order              Order?             @relation(fields: [order_id], references: [id])
  loan_account       LoanAccount?       @relation(fields: [loan_id], references: [id])
  user               User?              @relation(fields: [user_id], references: [id])
  payee              Payee?             @relation(fields: [payee_id], references: [id])
  repayment_schedule RepaymentSchedule? @relation(fields: [repayment_schedule_id], references: [id], onDelete: SetNull)

  @@map("repayment_records")
}

// 每日逾期记录表（去重按 schedule_id）
model OverdueRecord {
  id           Int      @id @default(autoincrement())
  user_id      Int
  loan_id      String
  schedule_id  Int      @unique
  collector    String   @db.VarChar(10)
  overdue_date DateTime
  created_at   DateTime @default(now())

  schedule RepaymentSchedule @relation(fields: [schedule_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([collector, overdue_date])
  @@index([overdue_date])
  @@index([user_id, overdue_date])
  @@map("overdue_records")
}

model Payee {
  id            Int       @id @default(autoincrement())
  admin_id      Int
  username      String    @db.VarChar(10)
  address       String    @db.VarChar(100)
  payment_limit Int       @default(20000)
  qrcode_number Int       @default(5)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt

  admin            Admin?                 @relation(fields: [admin_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  qrcode           QrCode[]
  orders           Order[]
  repaymentRecords RepaymentRecord[]
  ranking          PayeeRanking?
  dailyStatistics  PayeeDailyStatistics[]

  @@map("payees")
}

model QrCode {
  id          Int           @id @default(autoincrement())
  payee_id    Int
  qrcode_url  String        @db.VarChar(255)
  qrcode_type PaymentMethod @default(wechat_pay)
  active      Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime?     @updatedAt
  payee       Payee?        @relation(fields: [payee_id], references: [id])

  @@map("qr_codes")
}

enum OrderStatus {
  pending
  grabbed
  completed
  expired
  cancelled
}

// 在现有schema基础上添加订单表
model Order {
  id                      String           @id @default(cuid())
  customer_id             Int
  loan_id                 String
  amount                  Decimal          @db.Decimal(10, 2)
  payment_periods         Int
  payment_method          PaymentMethod
  remark                  String?          @db.VarChar(255)
  status                  OrderStatus      @default(pending)
  payee_id                Int?
  created_at              DateTime         @default(now())
  updated_at              DateTime?        @updatedAt
  expires_at              DateTime
  collected_by_type       CollectionSource @default(grabbed)
  processed_by_admin_id   Int?
  processed_by_admin_name String?          @db.VarChar(50)
  grabbed_at              DateTime?
  actual_paid_amount      Decimal?         @db.Decimal(10, 2)

  customer         User              @relation(fields: [customer_id], references: [id])
  payee            Payee?            @relation(fields: [payee_id], references: [id])
  repaymentRecords RepaymentRecord[]

  @@index([status, created_at])
  @@index([payee_id, created_at])
  @@index([customer_id, created_at])
  @@map("orders")
}

model DailyStatistics {
  id                Int      @id @default(autoincrement())
  admin_id          Int
  admin_name        String   @db.VarChar(10)
  date              DateTime @db.Date
  role              String   @db.VarChar(20) // 'collector' or 'risk_controller'
  new_in_stock_amount      Decimal  @db.Decimal(12, 2) @default(0) // 新增在库
  cleared_off_amount        Decimal  @db.Decimal(12, 2) @default(0) // 离库结清
  total_received           Decimal  @db.Decimal(12, 2) @default(0) // 已收
  total_unpaid             Decimal  @db.Decimal(12, 2) @default(0) // 未收
  total_handling_fee        Decimal  @db.Decimal(12, 2) @default(0) // 后扣
  total_fines              Decimal  @db.Decimal(12, 2) @default(0) // 罚金
  negotiated_count         Int      @default(0) // 协商
  blacklist_count          Int      @default(0) // 黑名单
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  admin Admin @relation(fields: [admin_id], references: [id])

  @@unique([admin_id, date, role])
  @@index([date])
  @@index([admin_id])
  @@map("daily_statistics")
}

model PayeeRanking {
  id         Int      @id @default(autoincrement())
  payee_id   Int      @unique
  decimal_sum Decimal  @default(0) @db.Decimal(10, 2)
  updated_at DateTime @updatedAt

  payee Payee @relation(fields: [payee_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("payee_rankings")
}

model PayeeDailyStatistics {
  id           Int      @id @default(autoincrement())
  payee_id     Int
  date         DateTime @db.Date
  daily_total  Decimal  @default(0) @db.Decimal(12, 2) // 每日收款总额
  total_amount Decimal  @default(0) @db.Decimal(12, 2) // 累计收款总金额
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  payee Payee @relation(fields: [payee_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([payee_id, date])
  @@index([payee_id, date])
  @@map("payee_daily_statistics")
}

// Operation log types
enum OperationType {
  CREATE
  UPDATE
  DELETE
}

// Operation logs for tracking entity changes
model OperationLog {
  id             Int           @id @default(autoincrement())
  entity_type    String        @db.VarChar(50) // 'LoanAccount', 'RepaymentSchedule', etc.
  entity_id      String        @db.VarChar(255) // ID of the entity
  operation_type OperationType
  admin_id       Int
  admin_username String        @db.VarChar(50)
  old_data       String?       @db.Text // JSON string of old data
  new_data       String?       @db.Text // JSON string of new data
  ip_address     String?       @db.VarChar(45)
  created_at     DateTime      @default(now())

  @@index([entity_type, created_at])
  @@index([admin_id, created_at])
  @@index([created_at])
  @@index([operation_type])
  @@map("operation_logs")
}

// 聊天消息类型
