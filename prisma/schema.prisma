generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  username     String    @db.VarChar(10)
  password     String    @default("123456") @db.VarChar(32)
  phone        String?   @db.VarChar(11)
  address      String    @db.VarChar(100)
  lv           String    @default("青铜用户") @db.VarChar(16)
  overtime     Int?      @default(0)
  overdue_time Int?      @default(0)
  is_high_risk Boolean?  @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime? @updatedAt

  loanAccounts     LoanAccount[]
  orders           Order[]
  repaymentRecords RepaymentRecord[]

  @@map("users")
}

enum ManagementRoles {
  ADMIN
  FINANCIAL
  RISK_CONTROLLER
  COLLECTOR
  PAYEE
  PAYER
}

model Admin {
  id        Int             @id @default(autoincrement())
  username  String          @db.VarChar(10)
  password  String          @default("123456") @db.VarChar(32)
  role      ManagementRoles
  createdAt DateTime        @default(now())
  updatedAt DateTime?       @updatedAt

  // 添加关系
  payees                       Payee[]
  loanAccountRoles             LoanAccountRole[]
  loanAccountsAsCollector      LoanAccount[]     @relation("CollectorLoanAccounts")
  loanAccountsAsRiskController LoanAccount[]     @relation("RiskControllerLoanAccounts")
  loanAccountsAsLender         LoanAccount[]     @relation("LenderLoanAccounts")
  dailyStatistics              DailyStatistics[]
  repaymentRecords             RepaymentRecord[]
  collectorAssetManagement      CollectorAssetManagement?
  riskControllerAssetManagement RiskControllerAssetManagement?
  assetReductionHistory    AssetReductionHistory[] @relation("AssetReductionHistory")

  @@map("admins")
}

// 复用的枚举（还款状态）
enum LoanAccountStatus {
  pending
  active
  overdue
  settled
  unsettled
  negotiated
  to_be_processed
  blacklist
}

enum RepaymentScheduleStatus {
  pending
  active
  overdue
  paid
  terminated
}

model LoanAccount {
  id                 String            @id @default(cuid())
  user_id            Int
  loan_amount        Decimal           @db.Decimal(10, 2)
  receiving_amount   Decimal?          @db.Decimal(10, 2)
  paid_capital       Decimal           @default(0) @db.Decimal(10, 2)
  paid_interest      Decimal           @default(0) @db.Decimal(10, 2)
  total_fines        Decimal           @default(0) @db.Decimal(10, 2)
  to_hand_ratio      Decimal?          @db.Decimal(10, 2)
  capital            Decimal           @db.Decimal(10, 2)
  interest           Decimal           @db.Decimal(10, 2)
  due_start_date     DateTime @db.Date
  due_end_date       DateTime @db.Date
  apply_times        Int               @default(0)
  status             LoanAccountStatus @default(pending)
  handling_fee       Decimal           @db.Decimal(10, 2)
  total_periods      Int
  repaid_periods     Int               @default(0)
  daily_repayment    Decimal           @db.Decimal(10, 2)
  risk_controller_id Int
  collector_id       Int
  lender_id          Int
  company_cost       Int               @default(0)
  created_at         DateTime          @default(now())
  created_by         Int
  updated_at         DateTime?         @updatedAt
  status_changed_at  DateTime?
  note               String?           @db.VarChar(300)
  last_edit_pay_capital   Decimal?     @db.Decimal(10, 2)
  last_edit_pay_interest  Decimal?     @db.Decimal(10, 2)
  last_edit_fines         Decimal?     @db.Decimal(10, 2)
  // 提前结清本金与利息（与已还本金/利息区分开）
  early_settlement_capital  Decimal?   @db.Decimal(10, 2)
  // 逾期数量（关联的RepaymentSchedule.status = 'overdue'的数量）
  overdue_count             Int        @default(0)
  // 归属（2个汉字长度）
  ownership                 String?    @db.VarChar(2)

  // 关系
  user               User                @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  risk_controller    Admin               @relation("RiskControllerLoanAccounts", fields: [risk_controller_id], references: [id])
  collector          Admin               @relation("CollectorLoanAccounts", fields: [collector_id], references: [id])
  lender             Admin               @relation("LenderLoanAccounts", fields: [lender_id], references: [id])
  repaymentSchedules RepaymentSchedule[]
  repaymentRecords   RepaymentRecord[]
  loanAccountRoles   LoanAccountRole[]

  @@map("loan_accounts")
}

model LoanAccountRole {
  id              Int      @id @default(autoincrement())
  loan_account_id String
  admin_id        Int
  role_type       String   @db.VarChar(20) // 'collector', 'risk_controller', 'payee', 'lender'
  created_at      DateTime @default(now())

  loan_account LoanAccount @relation(fields: [loan_account_id], references: [id], onDelete: Cascade)
  admin        Admin       @relation(fields: [admin_id], references: [id])

  @@unique([loan_account_id, admin_id, role_type])
  @@map("loan_account_roles")
}

model RepaymentSchedule {
  id                  Int                     @id @default(autoincrement())
  loan_id             String
  period              Int
  due_start_date      DateTime @db.Date
  due_amount          Decimal                 @db.Decimal(10, 2)
  capital             Decimal?                @db.Decimal(10, 2)
  interest            Decimal?                @db.Decimal(10, 2)
  paid_capital        Decimal?                @default(0) @db.Decimal(10, 2)
  paid_interest       Decimal?                @default(0) @db.Decimal(10, 2)
  fines               Decimal?                @default(0) @db.Decimal(10, 2)
  status              RepaymentScheduleStatus @default(pending)
  paid_amount         Decimal?                @db.Decimal(10, 2)
  paid_at             DateTime?
  collected_by_type   CollectionSource?
  operator_admin_id   Int?
  operator_admin_name String?                 @db.VarChar(50)

  // 外键关系到 LoanAccount
  loan_account     LoanAccount       @relation(fields: [loan_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  overdueRecords   OverdueRecord[]
  repaymentRecords RepaymentRecord[]

  @@map("repayment_schedules")
}

enum PaymentMethod {
  wechat_pay
  ali_pay
}

// 收款来源：抢单 or 手动
enum CollectionSource {
  grabbed
  manual
}

model RepaymentRecord {
  id                    Int              @id @default(autoincrement())
  loan_id               String
  user_id               Int
  paid_amount           Decimal?         @db.Decimal(10, 2)
  paid_at               DateTime         @default(now())
  payment_method        PaymentMethod    @default(wechat_pay)
  remark                String?          @db.VarChar(255)
  order_id              String
  collected_by_type     CollectionSource @default(grabbed)
  actual_collector_id   Int?
  paid_capital          Decimal?         @db.Decimal(10, 2)
  paid_interest         Decimal?         @db.Decimal(10, 2)
  paid_fines            Decimal?         @db.Decimal(10, 2)
  repayment_schedule_id Int?

  order              Order?             @relation(fields: [order_id], references: [id])
  loan_account       LoanAccount?       @relation(fields: [loan_id], references: [id])
  user               User?              @relation(fields: [user_id], references: [id])
  actual_collector   Admin?             @relation(fields: [actual_collector_id], references: [id])
  repayment_schedule RepaymentSchedule? @relation(fields: [repayment_schedule_id], references: [id], onDelete: SetNull)

  @@map("repayment_records")
}

// 每日逾期记录表（去重按 schedule_id）
model OverdueRecord {
  id           Int      @id @default(autoincrement())
  user_id      Int
  loan_id      String
  schedule_id  Int      @unique
  collector    String   @db.VarChar(10)
  overdue_date DateTime
  created_at   DateTime @default(now())

  schedule RepaymentSchedule @relation(fields: [schedule_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([collector, overdue_date])
  @@index([overdue_date])
  @@index([user_id, overdue_date])
  @@map("overdue_records")
}

model Payee {
  id            Int       @id @default(autoincrement())
  admin_id      Int
  username      String    @db.VarChar(10)
  address       String    @db.VarChar(100)
  payment_limit Int       @default(20000)
  remaining_limit Int     @default(20000)
  qrcode_number Int       @default(5)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt

  admin            Admin?                 @relation(fields: [admin_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  qrcode           QrCode[]
  orders           Order[]
  ranking          PayeeRanking?
  dailyStatistics  PayeeDailyStatistics[]

  @@map("payees")
}

model QrCode {
  id          Int           @id @default(autoincrement())
  payee_id    Int
  qrcode_url  String        @db.VarChar(255)
  qrcode_type PaymentMethod @default(wechat_pay)
  active      Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime?     @updatedAt
  payee       Payee?        @relation(fields: [payee_id], references: [id])

  @@map("qr_codes")
}

enum OrderStatus {
  pending
  grabbed
  completed
  expired
  cancelled
}

enum ManualProcessingStatus {
  processed
  unprocessed
}

enum PaymentFeedback {
  success
  failed
  no_feedback
}

enum ReviewStatus {
  pending_review
  reviewed
}

// 在现有schema基础上添加订单表
model Order {
  id                      String           @id @default(cuid())
  customer_id             Int
  loan_id                 String
  amount                  Decimal          @db.Decimal(10, 2)
  payment_periods         Int
  payment_method          PaymentMethod
  remark                  String?          @db.VarChar(255)
  status                  OrderStatus      @default(pending)
  payee_id                Int?
  created_at              DateTime         @default(now())
  updated_at              DateTime?        @updatedAt
  expires_at              DateTime
  collected_by_type       CollectionSource @default(grabbed)
  processed_by_admin_id   Int?
  processed_by_admin_name String?          @db.VarChar(50)
  grabbed_at              DateTime?
  actual_paid_amount      Decimal?         @db.Decimal(10, 2)
  needs_manual_processing Boolean          @default(false)
  manual_processing_status ManualProcessingStatus @default(unprocessed)
  payment_feedback        PaymentFeedback  @default(no_feedback)
  review_status           ReviewStatus     @default(pending_review)

  customer         User              @relation(fields: [customer_id], references: [id])
  payee            Payee?            @relation(fields: [payee_id], references: [id])
  repaymentRecords RepaymentRecord[]

  @@index([status, created_at])
  @@index([payee_id, created_at])
  @@index([customer_id, created_at])
  @@map("orders")
}

model DailyStatistics {
  id                Int      @id @default(autoincrement())
  admin_id          Int
  admin_name        String   @db.VarChar(10)
  date              DateTime @db.Date
  role              String   @db.VarChar(20) // 'collector' or 'risk_controller'
  
  // 总统计字段
  total_amount              Decimal  @db.Decimal(12, 2) @default(0) // 总金额
  total_in_stock_amount     Decimal  @db.Decimal(12, 2) @default(0) // 总在库金额
  total_handling_fee        Decimal  @db.Decimal(12, 2) @default(0) // 总手续费
  total_fines               Decimal  @db.Decimal(12, 2) @default(0) // 总罚金
  total_blacklist_count     Int      @default(0) // 总黑名单数
  total_negotiated_count    Int      @default(0) // 总协商数
  total_in_stock_count      Int      @default(0) // 总在库人数
  total_received_amount      Decimal  @db.Decimal(12, 2) @default(0) // 总收金额
  
  // 今日统计字段
  today_paid_count          Int      @default(0) // 今日已还清期数
  today_pending_count       Int      @default(0) // 今日待还款期数
  yesterday_overdue_count   Int      @default(0) // 昨日逾期数
  active_count              Int      @default(0) // 进行中期数
  today_negotiated_count    Int      @default(0) // 今日协商数
  today_blacklist_count     Int      @default(0) // 今日黑名单数
  today_collection          Decimal  @db.Decimal(12, 2) @default(0) // 今日收款
  yesterday_collection      Decimal  @db.Decimal(12, 2) @default(0) // 昨日收款
  today_new_amount          Decimal  @db.Decimal(12, 2) @default(0) // 今日新增在库
  today_settled_amount      Decimal  @db.Decimal(12, 2) @default(0) // 今日离库结清
  today_unpaid_amount       Decimal  @db.Decimal(12, 2) @default(0) // 今日待收
  today_handling_fee        Decimal  @db.Decimal(12, 2) @default(0) // 今日后扣
  today_fines               Decimal  @db.Decimal(12, 2) @default(0) // 今日罚金
  
  // 本月统计字段
  this_month_new_amount     Decimal  @db.Decimal(12, 2) @default(0) // 本月新增
  this_month_settled_amount Decimal  @db.Decimal(12, 2) @default(0) // 本月已还清
  this_month_handling_fee   Decimal  @db.Decimal(12, 2) @default(0) // 本月手续费
  this_month_fines          Decimal  @db.Decimal(12, 2) @default(0) // 本月罚金
  this_month_negotiated_count Int    @default(0) // 本月协商数
  this_month_blacklist_count  Int    @default(0) // 本月黑名单数
  
  // 上个月统计字段
  last_month_handling_fee   Decimal  @db.Decimal(12, 2) @default(0) // 上个月手续费
  last_month_fines          Decimal  @db.Decimal(12, 2) @default(0) // 上个月罚金
  last_month_blacklist_count Int      @default(0) // 上个月黑名单数
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  admin Admin @relation(fields: [admin_id], references: [id])

  @@unique([admin_id, date, role])
  @@index([date])
  @@index([admin_id])
  @@map("daily_statistics")
}

model PayeeRanking {
  id         Int      @id @default(autoincrement())
  payee_id   Int      @unique
  decimal_sum Decimal  @default(0) @db.Decimal(10, 2)
  updated_at DateTime @updatedAt

  payee Payee @relation(fields: [payee_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("payee_rankings")
}

model PayeeDailyStatistics {
  id           Int      @id @default(autoincrement())
  payee_id     Int
  date         DateTime @db.Date
  daily_total  Decimal  @default(0) @db.Decimal(12, 2) // 每日收款总额
  total_amount Decimal  @default(0) @db.Decimal(12, 2) // 累计收款总金额
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  payee Payee @relation(fields: [payee_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([payee_id, date])
  @@index([payee_id, date])
  @@map("payee_daily_statistics")
}

// Operation log types
enum OperationType {
  CREATE
  UPDATE
  DELETE
}

// Operation logs for tracking entity changes
model OperationLog {
  id             Int           @id @default(autoincrement())
  entity_type    String        @db.VarChar(50) // 'LoanAccount', 'RepaymentSchedule', etc.
  entity_id      String        @db.VarChar(255) // ID of the entity
  operation_type OperationType
  admin_id       Int
  admin_username String        @db.VarChar(50)
  old_data       String?       @db.Text // JSON string of old data
  new_data       String?       @db.Text // JSON string of new data
  ip_address     String?       @db.VarChar(45)
  created_at     DateTime      @default(now())

  @@index([entity_type, created_at])
  @@index([admin_id, created_at])
  @@index([created_at])
  @@index([operation_type])
  @@map("operation_logs")
}

model CollectorAssetManagement {
  id                Int      @id @default(autoincrement())
  admin_id          Int      @unique
  total_handling_fee Decimal  @default(0) @db.Decimal(10, 2)
  total_fines       Decimal  @default(0) @db.Decimal(10, 2)
  reduced_handling_fee Decimal @default(0) @db.Decimal(10, 2)
  reduced_fines     Decimal  @default(0) @db.Decimal(10, 2)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  admin Admin @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("collector_asset_management")
}

model RiskControllerAssetManagement {
  id           Int      @id @default(autoincrement())
  admin_id     Int      @unique
  total_amount Decimal  @default(0) @db.Decimal(10, 2)
  reduced_amount Decimal @default(0) @db.Decimal(10, 2)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  admin Admin @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("risk_controller_asset_management")
}

model LoanFieldPrediction {
  id           Int      @id @default(autoincrement())
  field_name   String   @db.VarChar(50) // loan_amount, to_hand_ratio, capital, interest, company_cost, handling_fee
  value        Decimal  @db.Decimal(10, 2)
  frequency    Int      @default(1)
  last_used_at DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([field_name, value])
  @@index([field_name, frequency])
  @@index([field_name, value])
  @@map("loan_field_predictions")
}

model AssetReductionHistory {
  id                Int      @id @default(autoincrement())
  admin_id          Int
  asset_type        String   @db.VarChar(50) // 'collector', 'risk_controller'
  field_name        String   @db.VarChar(50) // 'reduced_handling_fee', 'reduced_fines'
  old_value         Decimal  @db.Decimal(10, 2)
  input_value       Decimal  @db.Decimal(10, 2)
  new_value         Decimal  @db.Decimal(10, 2)
  updated_by_admin_id Int?
  updated_by_admin_username String? @db.VarChar(50)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  admin Admin @relation("AssetReductionHistory", fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("asset_reduction_history")
}